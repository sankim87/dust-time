<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIME LEAK: ë¨¼ì§€ ë†ì¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+KR:wght@300;500;700&display=swap');

        body {
            font-family: 'JetBrains Mono', 'Noto Sans KR', monospace;
            background-color: #111;
            color: #ccc;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            word-break: keep-all;
        }

        /* --- Visual Styles --- */
        .glass-panel {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .btn-action {
            transition: all 0.1s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-action:active {
            transform: scale(0.97);
        }
        .btn-action:disabled {
            opacity: 0.4;
            filter: grayscale(100%);
            cursor: not-allowed;
        }

        /* Effects */
        .shake-mild { animation: shake 0.5s infinite; }
        .shake-hard { animation: violent-shake 0.3s infinite; }

        @keyframes shake {
            0% { transform: translate(0.5px, 0.5px); }
            50% { transform: translate(-0.5px, -0.5px); }
            100% { transform: translate(0.5px, -0.5px); }
        }
        @keyframes violent-shake {
            0% { transform: translate(2px, 2px); }
            25% { transform: translate(-2px, -2px); }
            50% { transform: translate(2px, -2px); }
            75% { transform: translate(-2px, 2px); }
            100% { transform: translate(0, 0); }
        }

        /* Bars */
        .bar-container { background: #222; height: 10px; border-radius: 2px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; transition: width 0.2s linear; }

        /* Text Effects */
        .highlight-dust { color: #fbbf24; text-shadow: 0 0 5px rgba(251, 191, 36, 0.5); }
        .highlight-essence { color: #f87171; text-shadow: 0 0 5px rgba(248, 113, 113, 0.5); }
        
        .hidden-page { display: none !important; }

        /* Floating particles for aesthetics */
        .particle {
            position: absolute;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            pointer-events: none;
            animation: floatUp 10s linear infinite;
        }
        @keyframes floatUp {
            from { transform: translateY(100vh); opacity: 0; }
            50% { opacity: 0.5; }
            to { transform: translateY(-10vh); opacity: 0; }
        }

    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center relative overflow-hidden">
    
    <!-- Background Particles -->
    <div id="particles-container" class="absolute inset-0 pointer-events-none"></div>

    <!-- 1. START SCREEN -->
    <section id="start-screen" class="text-center p-8 max-w-md w-full z-10 animate-fade-in">
        <h1 class="text-5xl font-bold mb-2 text-gray-200 tracking-tighter">THE DUST FARM</h1>
        <p class="text-xs text-gray-500 mb-8 tracking-[0.4em] uppercase">ë¨¼ì§€ ë†ì¥ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>
        
        <div class="glass-panel p-6 rounded mb-8 text-left border-l-2 border-yellow-600">
            <p class="text-sm text-gray-300 mb-4 leading-relaxed font-light">
                ë°˜ê°‘ìŠµë‹ˆë‹¤, ê´€ë¦¬ìë‹˜.<br>
                ì´ê³³ì€ ë‹¹ì‹ ì˜ <span class="highlight-essence">ë³¸ì§ˆ(ì‹œê°„)</span>ì„ íƒœì›Œ<br>
                <span class="highlight-dust">ë¨¼ì§€(ì„±ê³¼)</span>ë¥¼ ìƒì‚°í•˜ëŠ” ë†ì¥ì…ë‹ˆë‹¤.
            </p>
            <div class="text-xs text-gray-500 space-y-2 bg-black/30 p-3 rounded">
                <p>1. <strong>ë…¸ë™ (ì±„êµ´):</strong> ë¨¼ì§€ë¥¼ ì–»ì§€ë§Œ, ê³¼ì—´ë©ë‹ˆë‹¤.</p>
                <p>2. <strong>ë©ˆì¶¤ (ëƒ‰ê°):</strong> ê³¼ì—´ì„ ì‹íˆì§€ë§Œ, ë„íƒœë©ë‹ˆë‹¤.</p>
                <p>3. <strong>íš¨ìœ¨ (ê±°ë˜):</strong> ë” ë¹¨ë¦¬ ëª¨ìœ¼ì§€ë§Œ, ìˆ˜ëª…ì„ ê¹ìŠµë‹ˆë‹¤.</p>
            </div>
            <p class="mt-4 text-xs text-center text-gray-400">
                "ë‹¹ì‹ ì˜ ì‹œê°„ì€ ì–¼ë§ˆì§œë¦¬ ë¨¼ì§€ì…ë‹ˆê¹Œ?"
            </p>
        </div>

        <button onclick="startGame()" class="w-full py-4 bg-yellow-700 hover:bg-yellow-600 text-white font-bold text-lg rounded transition border border-yellow-500/30 shadow-[0_0_15px_rgba(234,179,8,0.3)]">
            [ ê³„ì•½ ì²´ê²° ë° ì±„êµ´ ì‹œì‘ ]
        </button>

        <div class="glass-panel p-4 rounded mt-6 border border-gray-800">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">ëª…ì˜ˆì˜ ì „ë‹¹ (ìƒìœ„ 5ëª…)</h3>
                <button onclick="refreshLeaderboard()" class="text-[10px] text-yellow-500 hover:text-yellow-300">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <ol id="start-leaderboard" class="space-y-2"></ol>
            <p class="text-[10px] text-gray-500 mt-2">ê³„ì•½ ì¢…ë£Œ ì‹œ ê¸°ë¡ì´ ì œì¶œë˜ë©°, ìƒìœ„ 5ëª…ë§Œ ë‚¨ìŠµë‹ˆë‹¤.</p>
        </div>
    </section>

    <!-- 2. GAME SCREEN -->
    <section id="game-screen" class="hidden-page w-full h-full max-w-md flex flex-col relative z-10 p-4">
        
        <!-- Header -->
        <div class="glass-panel p-4 rounded mb-4 flex justify-between items-center">
            <div>
                <span class="text-[10px] text-gray-500 block tracking-widest uppercase">ëˆ„ì  ì„±ê³¼ (ë¨¼ì§€)</span>
                <span id="score-display" class="text-3xl font-bold text-yellow-400 font-mono">0 g</span>
            </div>
            <div class="text-right">
                <span class="text-[10px] text-gray-500 block tracking-widest uppercase">í˜„ì¬ ê²½ìŸ ìˆœìœ„</span>
                <span id="rank-display" class="text-sm text-gray-400 font-mono">ì§‘ê³„ ì¤‘...</span>
            </div>
        </div>

        <!-- Status Monitor -->
        <div class="space-y-4 mb-6 relative p-2">
            
            <!-- Life (Essence) -->
            <div>
                <div class="flex justify-between text-[11px] mb-1">
                    <span class="text-gray-400">ë‹¹ì‹ ì˜ ì”ì—¬ ìˆ˜ëª…</span>
                    <span id="life-text" class="text-gray-400">100.0%</span>
                </div>
                <div class="bar-container">
                    <!-- Max Capacity Marker (Red Zone) -->
                    <div id="life-cap-marker" class="absolute top-0 right-0 h-full bg-red-900/40 w-0 transition-all duration-500 border-l border-red-500/50"></div>
                    <div id="life-bar" class="bar-fill bg-gradient-to-r from-gray-500 to-white w-full"></div>
                </div>
            </div>

            <!-- Heat (Entropy) -->
            <div>
                <div class="flex justify-between text-[11px] mb-1">
                    <span class="text-red-400 font-bold" id="heat-label">íƒìš•ì˜ ì—´ê¸° (ê³¼ë¶€í•˜)</span>
                    <span id="entropy-text" class="text-red-400">0%</span>
                </div>
                <div class="bar-container border border-red-900/30">
                    <div id="entropy-bar" class="bar-fill bg-red-600 w-0"></div>
                </div>
                <p id="system-msg" class="text-[10px] text-gray-600 mt-1 text-right h-4">ì‹œìŠ¤í…œ ì •ìƒ ê°€ë™ ì¤‘</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="grid grid-cols-2 gap-3 mb-4">
            <!-- WORK -->
            <button id="btn-work" onclick="actionWork()" class="btn-action glass-panel p-6 rounded flex flex-col items-center justify-center hover:bg-gray-800 border-gray-600 active:bg-yellow-900/20 group">
                <span class="text-2xl mb-1 group-hover:scale-110 transition">â›ï¸</span>
                <span class="font-bold text-yellow-400">ë…¸ë™ (ì±„êµ´)</span>
                <span class="text-[10px] text-gray-500 mt-1">ì„±ê³¼ íšë“ / <span class="text-red-400">+ê³¼ì—´</span></span>
            </button>

            <!-- REST -->
            <button id="btn-rest" onclick="actionRest()" class="btn-action glass-panel p-6 rounded flex flex-col items-center justify-center hover:bg-gray-800 border-gray-600 active:bg-blue-900/20 group">
                <span class="text-2xl mb-1 group-hover:scale-110 transition">ğŸ§Š</span>
                <span class="font-bold text-blue-400">ì ê¹ ë©ˆì¶¤</span>
                <span class="text-[10px] text-gray-500 mt-1">ì—´ê¸° ëƒ‰ê° / <span class="text-yellow-600">ì‹œê°„ ë‚­ë¹„</span></span>
            </button>
        </div>

        <!-- Shop -->
        <div class="flex-1 glass-panel rounded p-4 overflow-y-auto border-t-2 border-yellow-900/30">
            <h3 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-widest border-b border-gray-700 pb-2">íš¨ìœ¨ì„±ì˜ ì œë‹¨ (ê±°ë˜ì†Œ)</h3>
            
            <div class="space-y-2">
                <button onclick="buyUpgrade(1)" id="upg-1" class="w-full p-3 bg-black/40 border border-gray-800 rounded flex justify-between items-center hover:border-yellow-600 transition disabled:opacity-30">
                    <div class="text-left">
                        <div class="font-bold text-xs text-gray-300">ìŒê³¡ê´­ì´ì§ˆ (ë©€í‹°íƒœìŠ¤í‚¹)</div>
                        <div class="text-[9px] text-gray-500">ì±„êµ´ëŸ‰ 2ë°° / ì—´ê¸° +10%</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-yellow-500">60 g</div>
                        <div class="text-[9px] text-red-500">ìµœëŒ€ ìˆ˜ëª… -10%</div>
                    </div>
                </button>

                <button onclick="buyUpgrade(2)" id="upg-2" class="w-full p-3 bg-black/40 border border-gray-800 rounded flex justify-between items-center hover:border-yellow-600 transition disabled:opacity-30">
                    <div class="text-left">
                        <div class="font-bold text-xs text-gray-300">ìë™ ì±„êµ´ ë´‡</div>
                        <div class="text-[9px] text-gray-500">ìë™ ì±„êµ´ / ì§€ì†ì  ê³¼ì—´</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-yellow-500">250 g</div>
                        <div class="text-[9px] text-red-500">ìµœëŒ€ ìˆ˜ëª… -20%</div>
                    </div>
                </button>

                <button onclick="buyUpgrade(3)" id="upg-3" class="w-full p-3 bg-black/40 border border-gray-800 rounded flex justify-between items-center hover:border-yellow-600 transition disabled:opacity-30">
                    <div class="text-left">
                        <div class="font-bold text-xs text-gray-300">ì‹ ê²½ ê°€ì† (ë„íŒŒë¯¼)</div>
                        <div class="text-[9px] text-gray-500">ì±„êµ´ëŸ‰ 3ë°° / ì¹˜ëª…ì  ê³¼ì—´</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-yellow-500">700 g</div>
                        <div class="text-[9px] text-red-500">ìµœëŒ€ ìˆ˜ëª… -30%</div>
                    </div>
                </button>
            </div>
            <p class="text-[9px] text-center text-gray-600 mt-3 italic">"ê±°ë˜ëœ ìˆ˜ëª…ì€ í™˜ë¶ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."</p>
        </div>

    </section>

    <!-- 3. END SCREEN -->
    <section id="end-screen" class="hidden-page text-center p-8 max-w-md w-full z-10 flex flex-col items-center">
        
        <h2 class="text-4xl font-black text-gray-200 mb-2">ê³„ì•½ ì¢…ë£Œ</h2>
        <div class="w-16 h-1 bg-red-600 mb-8"></div>
        
        <div class="glass-panel p-6 rounded w-full text-left mb-6 space-y-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                <span class="text-xs text-gray-400 uppercase">ìµœì¢… ì„±ê³¼ (ë¨¼ì§€)</span>
                <span class="text-2xl font-bold text-yellow-400" id="end-score">0 g</span>
            </div>
            
            <div class="grid grid-cols-2 gap-4 text-xs">
                <div>
                    <span class="block text-gray-500">ì¢…ë£Œ ì‚¬ìœ </span>
                    <span class="block text-red-400 font-bold mt-1" id="end-reason">ì•Œ ìˆ˜ ì—†ìŒ</span>
                </div>
                <div class="text-right">
                    <span class="block text-gray-500">ì§€ë¶ˆí•œ ìˆ˜ëª…</span>
                    <span class="block text-gray-300 font-bold mt-1" id="end-sacrifice">0%</span>
                </div>
            </div>
        </div>

        <div id="final-message" class="text-sm font-serif italic text-gray-400 leading-relaxed min-h-[80px] px-4">
            <!-- Messages will be injected here -->
        </div>

        <div class="glass-panel p-4 rounded w-full mt-6 space-y-3 border border-gray-800">
            <p class="text-xs text-gray-400">ê³„ì•½ ì¢…ë£Œ í›„, ì´ë¦„ì„ ë‚¨ê¸°ë©´ ëª…ì˜ˆì˜ ì „ë‹¹ì— ê¸°ë¡ë©ë‹ˆë‹¤.</p>
            <input id="player-name" type="text" maxlength="32" placeholder="ìµëª… ë…¸ë™ì" class="w-full bg-black/40 border border-gray-700 rounded px-3 py-2 text-sm text-gray-200 focus:outline-none focus:border-yellow-500" />
            <button id="submit-score" onclick="submitScore()" class="w-full py-3 bg-yellow-700 hover:bg-yellow-600 text-white font-bold text-sm rounded transition border border-yellow-500/30">ëª…ì˜ˆì˜ ì „ë‹¹ì— ì˜¬ë¦¬ê¸°</button>
            <p id="submit-status" class="text-[11px] text-gray-500">ìƒìœ„ 5ëª…ì˜ ê¸°ë¡ë§Œ ë³´ì¡´ë©ë‹ˆë‹¤.</p>
        </div>

        <div class="glass-panel p-4 rounded w-full mt-4 border border-gray-800">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">í˜„ì¬ ëª…ì˜ˆì˜ ì „ë‹¹</h3>
                <button onclick="refreshLeaderboard()" class="text-[10px] text-yellow-500 hover:text-yellow-300">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <ol id="end-leaderboard" class="space-y-2 w-full"></ol>
        </div>

        <button onclick="location.reload()" class="mt-8 text-xs text-gray-500 border border-gray-700 px-8 py-3 hover:bg-gray-800 hover:text-white transition uppercase tracking-widest">
            ìƒˆ ê³„ì•½ ì²´ê²° (ë‹¤ì‹œ í•˜ê¸°)
        </button>
    </section>

    <script>
        // Create background particles
        const pc = document.getElementById('particles-container');
        for(let i=0; i<20; i++){
            let d = document.createElement('div');
            d.className = 'particle';
            d.style.left = Math.random()*100 + '%';
            d.style.width = Math.random()*4 + 2 + 'px';
            d.style.height = d.style.width;
            d.style.animationDuration = Math.random()*10 + 10 + 's';
            d.style.animationDelay = Math.random()*5 + 's';
            pc.appendChild(d);
        }

        /* --- CONFIGURATION --- */
        const TICK_RATE = 100; // 0.1s tick
        const BASE_LIFE_DRAIN = 0.03; // Base life loss per tick
        
        /* --- STATE --- */
        let state = {
            active: false,
            score: 0,
            life: 100.0,
            maxLife: 100,
            heat: 0,
            
            // Multipliers
            clickPower: 1,
            autoRate: 0,
            globalMult: 1,
            heatGenMult: 1
        };

        let leaderboardData = [];
        let hasSubmittedScore = false;
        let loops = { game: null, auto: null };

        const els = {
            screens: { start: document.getElementById('start-screen'), game: document.getElementById('game-screen'), end: document.getElementById('end-screen') },
            score: document.getElementById('score-display'),
            rank: document.getElementById('rank-display'),
            leaderboard: { start: document.getElementById('start-leaderboard'), end: document.getElementById('end-leaderboard') },
            lifeBar: document.getElementById('life-bar'),
            lifeText: document.getElementById('life-text'),
            lifeCap: document.getElementById('life-cap-marker'),
            entropyBar: document.getElementById('entropy-bar'),
            entropyText: document.getElementById('entropy-text'),
            sysMsg: document.getElementById('system-msg'),
            gameBody: document.getElementById('game-screen'),
            upgrades: [document.getElementById('upg-1'), document.getElementById('upg-2'), document.getElementById('upg-3')],
            playerName: document.getElementById('player-name'),
            submitBtn: document.getElementById('submit-score'),
            submitStatus: document.getElementById('submit-status')
        };

        async function readJsonSafe(res) {
            const text = await res.text();
            if (!text) return null;
            try {
                return JSON.parse(text);
            } catch (err) {
                console.error('JSON parse failed', err, text);
                return null;
            }
        }

        async function refreshLeaderboard() {
            try {
                const res = await fetch('/api/leaderboard');
                const data = await readJsonSafe(res);
                leaderboardData = data?.entries || [];
                renderLeaderboard(leaderboardData, els.leaderboard.start);
                renderLeaderboard(leaderboardData, els.leaderboard.end);
                updateRankDisplay();
            } catch (err) {
                console.error('Leaderboard fetch failed', err);
                els.rank.innerText = 'ì§‘ê³„ ë¶ˆê°€';
            }
        }

        function renderLeaderboard(entries, target) {
            if (!target) return;
            target.innerHTML = '';

            if (!entries || entries.length === 0) {
                const empty = document.createElement('li');
                empty.className = 'text-[11px] text-gray-500';
                empty.innerText = 'ê¸°ë¡ ì—†ìŒ';
                target.appendChild(empty);
                return;
            }

            entries.forEach((entry, idx) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-sm text-gray-200 bg-black/30 border border-gray-800 rounded px-3 py-2';
                li.innerHTML = `<span class="font-mono text-yellow-400">${idx + 1}ìœ„</span><span class="flex-1 ml-2 truncate">${entry.name}</span><span class="font-mono text-gray-400">${Number(entry.score).toLocaleString()} g</span>`;
                target.appendChild(li);
            });
        }

        function updateRankDisplay() {
            if (!els.rank) return;
            if (!leaderboardData.length) {
                els.rank.innerText = 'ì§‘ê³„ ì¤‘';
                return;
            }
            const top = leaderboardData[0];
            els.rank.innerText = `${top.name} - ${Number(top.score).toLocaleString()} g`;
        }

        /* --- CORE LOGIC --- */
        function startGame() {
            els.screens.start.classList.add('hidden-page');
            els.screens.game.classList.remove('hidden-page');
            state.active = true;
            
            loops.game = setInterval(gameTick, TICK_RATE);
            loops.auto = setInterval(autoTick, 1000);
        }

        function gameTick() {
            if (!state.active) return;

            // 1. Life Drain Logic
            let currentDrain = BASE_LIFE_DRAIN;

            if (state.heat > 50) currentDrain *= 1.5;
            if (state.heat > 80) currentDrain *= 2.5;
            if (state.heat >= 99) currentDrain *= 5.0; // Critical

            state.life -= currentDrain;

            // 2. Heat Recovery
            if (state.heat > 0) state.heat -= 0.15;
            // 3. Game Over Checks
            if (state.heat >= 100) gameOver("ì—”ì§„ í­ë°œ (ê³¼ë„í•œ ìš•ì‹¬)");
            if (state.life <= 0) gameOver("ë³¸ì§ˆ ì†Œë©¸ (ê³¼ë¡œì‚¬)");

            updateUI();
        }

        function autoTick() {
            if (!state.active) return;
            if (state.autoRate > 0) {
                state.score += (state.autoRate * state.globalMult);
                state.heat += (state.autoRate * 0.2); 
            }
        }

        function updateUI() {
            if (!state.active) return;

            // Score & Rank
            els.score.innerText = Math.floor(state.score).toLocaleString() + " g";
            updateRankDisplay();

            // Life Bar
            let lifePct = Math.max(0, state.life);
            let displayLife = (state.life / 100) * 100; 
            els.lifeBar.style.width = `${displayLife}%`;
            els.lifeText.innerText = `${lifePct.toFixed(1)}%`;
            els.lifeCap.style.width = `${100 - state.maxLife}%`;

            // Heat Bar
            let heatPct = Math.min(100, Math.max(0, state.heat));
            els.entropyBar.style.width = `${heatPct}%`;
            els.entropyText.innerText = `${Math.floor(heatPct)}%`;

            // Visual Feedback based on Heat
            if (state.heat > 80) {
                els.sysMsg.innerText = "âš  ê²½ê³ : í­ë°œ ì„ë°• (ìœ„í—˜)";
                els.sysMsg.className = "text-[10px] mt-1 text-right font-bold text-red-500 blink";
                els.gameBody.className = "w-full h-full max-w-md flex flex-col relative z-10 p-4 shake-hard";
            } else if (state.heat > 50) {
                els.sysMsg.innerText = "ì£¼ì˜: íš¨ìœ¨ ê¸‰ê° ì¤‘";
                els.sysMsg.className = "text-[10px] mt-1 text-right text-yellow-500";
                els.gameBody.className = "w-full h-full max-w-md flex flex-col relative z-10 p-4 shake-mild";
            } else {
                els.sysMsg.innerText = "ì‹œìŠ¤í…œ ì •ìƒ ê°€ë™ ì¤‘";
                els.sysMsg.className = "text-[10px] mt-1 text-right text-green-700";
                els.gameBody.className = "w-full h-full max-w-md flex flex-col relative z-10 p-4";
            }

            // Shop Buttons
            checkAfford(0, 60);
            checkAfford(1, 250);
            checkAfford(2, 700);
        }

        function checkAfford(idx, cost) {
            let btn = els.upgrades[idx];
            let canAfford = state.score >= cost && state.maxLife > (idx+1)*10 + 5;
            btn.disabled = !canAfford;
            if(!canAfford) btn.style.opacity = "0.4";
            else btn.style.opacity = "1";
        }

        /* --- ACTIONS --- */
        function actionWork() {
            if (!state.active) return;
            state.score += (state.clickPower * state.globalMult);
            state.heat += (3 * state.heatGenMult); 
            updateUI();
        }

        function actionRest() {
            if (!state.active) return;
            state.heat = Math.max(0, state.heat - 15);
            if(state.score > 0) state.score = Math.max(0, state.score - 2); 
            updateUI();
        }

        function buyUpgrade(type) {
            if (!state.active) return;
            if (type === 1) { // Pickaxe
                if (state.score < 60) return;
                state.score -= 60;
                state.maxLife -= 10;
                state.clickPower += 2;
                state.heatGenMult += 0.2; 
            } else if (type === 2) { // Auto Bot
                if (state.score < 250) return;
                state.score -= 250;
                state.maxLife -= 20;
                state.autoRate += 5;
            } else if (type === 3) { // Neural
                if (state.score < 700) return;
                state.score -= 700;
                state.maxLife -= 30;
                state.globalMult += 1;
                state.heatGenMult += 0.5;
            }
            state.life = Math.min(state.life, state.maxLife);
            updateUI();
        }

        function resetSubmissionUI() {
            hasSubmittedScore = false;
            if (els.submitBtn) els.submitBtn.disabled = false;
            if (els.submitStatus) {
                els.submitStatus.innerText = 'ìƒìœ„ 5ëª…ì˜ ê¸°ë¡ë§Œ ë³´ì¡´ë©ë‹ˆë‹¤.';
                els.submitStatus.className = 'text-[11px] text-gray-500';
            }
        }

        async function submitScore() {
            if (hasSubmittedScore || !els.submitBtn) return;

            els.submitBtn.disabled = true;
            if (els.submitStatus) {
                els.submitStatus.innerText = 'ê¸°ë¡ ì „ì†¡ ì¤‘...';
                els.submitStatus.className = 'text-[11px] text-gray-400';
            }

            try {
                const payload = {
                    name: (els.playerName?.value || '').trim() || 'ìµëª… ë…¸ë™ì',
                    score: Math.floor(state.score)
                };

                const res = await fetch('/api/leaderboard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await readJsonSafe(res);
                if (!data) {
                    throw new Error('ì„œë²„ ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                if (!res.ok || data.error) {
                    throw new Error(data.error || 'ì ìˆ˜ ê¸°ë¡ ì‹¤íŒ¨');
                }

                hasSubmittedScore = true;
                leaderboardData = data.entries || leaderboardData;
                renderLeaderboard(leaderboardData, els.leaderboard.start);
                renderLeaderboard(leaderboardData, els.leaderboard.end);
                updateRankDisplay();

                if (els.submitStatus) {
                    els.submitStatus.innerText = 'ëª…ì˜ˆì˜ ì „ë‹¹ì— ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    els.submitStatus.className = 'text-[11px] text-green-400';
                }
            } catch (err) {
                console.error('Submit failed', err);
                if (els.submitStatus) {
                    els.submitStatus.innerText = 'ê¸°ë¡ ì‹¤íŒ¨: ' + err.message;
                    els.submitStatus.className = 'text-[11px] text-red-400';
                }
                els.submitBtn.disabled = false;
            }
        }

        /* --- END GAME --- */
        function gameOver(reason) {
            state.active = false;
            clearInterval(loops.game);
            clearInterval(loops.auto);
            els.gameBody.className = "w-full h-full max-w-md flex flex-col relative z-10 p-4"; // Stop shake

            els.screens.game.classList.add('hidden-page');
            els.screens.end.classList.remove('hidden-page');

            resetSubmissionUI();
            if (els.playerName) els.playerName.value = '';
            refreshLeaderboard();

            document.getElementById('end-score').innerText = Math.floor(state.score).toLocaleString() + " g";
            document.getElementById('end-reason').innerText = reason;
            document.getElementById('end-sacrifice').innerText = (100 - state.maxLife) + "%";

            // Narrative Logic
            let msg = "";
            if (state.score < 500) {
                msg = "ìš•ì‹¬ ì—†ëŠ” ì‚¶ì´ì—ˆìœ¼ë‚˜,<br>ë‚¨ë“¤ì´ ë³´ê¸°ì—” ê·¸ì € ê²Œìœ¼ë¥¸ í–‰ì¸ì´ì—ˆìŠµë‹ˆë‹¤.<br>ë‹¹ì‹ ì˜ ì‹œê°„ì€ ì •ë§ ë‹¹ì‹ ì˜ ê²ƒì´ì—ˆìŠµë‹ˆê¹Œ?";
            } else if (state.score < 3000) {
                msg = "ì ë‹¹íˆ ì¼í•˜ê³  ì ë‹¹íˆ ë‹³ì•˜ìŠµë‹ˆë‹¤.<br>ì´ ë¨¼ì§€ë”ë¯¸ë¥¼ ìœ„í•´ ë‹¹ì‹ ì€ ì²­ì¶˜ì„ ë°”ì³¤ìŠµë‹ˆë‹¤.<br>ë‹¹ì‹ ì€ ëŒ€ì²´ ê°€ëŠ¥í•œ ë¶€í’ˆì´ì—ˆìŠµë‹ˆë‹¤.";
            } else {
                msg = "ìœ„ëŒ€í•œ ì„±ê³¼ì…ë‹ˆë‹¤! ì—„ì²­ë‚œ ë¨¼ì§€ ì‚°ì´ë„¤ìš”.<br>ê·¸ ëŒ€ê°€ë¡œ ë‹¹ì‹ ì€ ìì‹ ì„ ì™„ë²½í•˜ê²Œ íƒœì›Œ ì—†ì•´ìŠµë‹ˆë‹¤.<br>ê¸°ê³„ê°€ ëœ ê¸°ë¶„ì´ ì–´ë– ì‹ ê°€ìš”?";
            }

            // Typing Effect
            let i = 0;
            const target = document.getElementById('final-message');
            target.innerHTML = "";
            const timer = setInterval(() => {
                if (i < msg.length) {
                    let char = msg.charAt(i) === '<' ? '<br>' : msg.charAt(i);
                    if (char === '<br>') i += 3; // Skip <br> tags roughly
                    target.innerHTML = msg.substring(0, i+1);
                    i++;
                } else {
                    clearInterval(timer);
                }
            }, 30);
        }

        refreshLeaderboard();
    </script>
</body>
</html>
